name: Deploy Backend to Azure App Service

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "Dockerfile.backend"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: ${{ vars.AZURE_BACKEND_APP_NAME }}       # e.g. interview-paper-backend
  ACR_LOGIN_SERVER: ${{ vars.AZURE_ACR_LOGIN_SERVER }}         # e.g. myregistry.azurecr.io
  IMAGE_NAME: interview-paper-backend

jobs:
  # ─────────────────────────────────────────────
  # 1. Build & push Docker image to ACR
  # ─────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ env.ACR_LOGIN_SERVER }}

      - name: Build & push Docker image
        id: meta
        run: |
          IMAGE_TAG="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest"

          docker build \
            -f Dockerfile.backend \
            -t "$IMAGE_TAG" \
            -t "$IMAGE_LATEST" \
            .

          docker push "$IMAGE_TAG"
          docker push "$IMAGE_LATEST"
          echo "tags=$IMAGE_TAG" >> "$GITHUB_OUTPUT"

  # ─────────────────────────────────────────────
  # 2. Deploy to Azure App Service
  # ─────────────────────────────────────────────
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set App Service container image
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ needs.build.outputs.image_tag }}

      - name: Configure App Settings
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          app-settings-json: |
            [
              { "name": "WEBSITES_PORT",                          "value": "8000" },
              { "name": "AZURE_SERVICE_BUS_CONNECTION_STRING",    "value": "${{ secrets.AZURE_SERVICE_BUS_CONNECTION_STRING }}" },
              { "name": "COSMOS_DB_CONNECTION_STRING",            "value": "${{ secrets.COSMOS_DB_CONNECTION_STRING }}" },
              { "name": "AZURE_STORAGE_ACCOUNT_NAME",            "value": "${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" },
              { "name": "AZURE_STORAGE_ACCOUNT_KEY",             "value": "${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" },
              { "name": "ANTHROPIC_API_KEY",                     "value": "${{ secrets.ANTHROPIC_API_KEY }}" },
              { "name": "OPENAI_API_KEY",                        "value": "${{ secrets.OPENAI_API_KEY }}" },
              { "name": "AI_PROVIDER",                           "value": "anthropic" },
              { "name": "AI_MODEL",                              "value": "claude-3-sonnet-20240229" },
              { "name": "DEBUG",                                 "value": "false" }
            ]

      - name: Azure logout
        run: az logout
